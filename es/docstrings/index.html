
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A data pipeline for NYC Taxi data, using Snowflake, dbt, and GitHub Actions. This project automates the ingestion, transformation, and governance of NYC Taxi datasets. Explore the architecture, execution workflows, and data governance practices.
">
      
      
        <meta name="author" content="Mezine Elias">
      
      
        <link rel="canonical" href="https://eliasmez.github.io/nyc-taxi-pipeline/es/docstrings/">
      
      
        <link rel="prev" href="../execution/">
      
      
      
        
          <link rel="alternate" href="../../docstrings/" hreflang="en">
        
          <link rel="alternate" href="../../fr/docstrings/" hreflang="fr">
        
          <link rel="alternate" href="./" hreflang="es">
        
          <link rel="alternate" href="../../zh/docstrings/" hreflang="zh">
        
          <link rel="alternate" href="https://eliasmez.github.io/nyc-taxi-pipeline/dbt/" hreflang="null">
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>üìö Docstrings - NYC Taxi Data Pipeline</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-2HYW7TB2WR"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-2HYW7TB2WR",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-2HYW7TB2WR",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#docstrings-python" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../" title="NYC Taxi Data Pipeline" class="md-header__button md-logo" aria-label="NYC Taxi Data Pipeline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NYC Taxi Data Pipeline
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              üìö Docstrings
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to auto mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to auto mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Seleccionar idioma">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../docstrings/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../fr/docstrings/" hreflang="fr" class="md-select__link">
              Fran√ßais
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="es" class="md-select__link">
              Espa√±ol
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh/docstrings/" hreflang="zh" class="md-select__link">
              ‰∏≠Êñá
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="https://eliasmez.github.io/nyc-taxi-pipeline/dbt/" hreflang="null" class="md-select__link">
              dbt docs
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="B√∫squeda" placeholder="B√∫squeda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/EliasMez/nyc-taxi-pipeline/" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    nyc-taxi-pipeline
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Pesta√±as" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  üöï Inicio

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../architecture/" class="md-tabs__link">
        
  
  
    
  
  üèõÔ∏è Arquitectura

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../governance/" class="md-tabs__link">
        
  
  
    
  
  üìà Gobernanza

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../execution/" class="md-tabs__link">
        
  
  
    
  
  üöÄ Ejecuci√≥n

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  üìö Docstrings

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navegaci√≥n" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../" title="NYC Taxi Data Pipeline" class="md-nav__button md-logo" aria-label="NYC Taxi Data Pipeline" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    NYC Taxi Data Pipeline
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/EliasMez/nyc-taxi-pipeline/" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    nyc-taxi-pipeline
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üöï Inicio
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üèõÔ∏è Arquitectura
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../governance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üìà Gobernanza
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üöÄ Ejecuci√≥n
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    üìö Docstrings
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    üìö Docstrings
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions.config_logger" class="md-nav__link">
    <span class="md-ellipsis">
      
        config_logger
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions.connect_with_role" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect_with_role
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions.plural_suffix" class="md-nav__link">
    <span class="md-ellipsis">
      
        plural_suffix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions.run_sql_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_sql_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.functions.use_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        use_context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_infra_snowflake
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="init_infra_snowflake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake.create_roles_and_user" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_roles_and_user
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake.grant_privileges" class="md-nav__link">
    <span class="md-ellipsis">
      
        grant_privileges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake.set_data_retention" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_data_retention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.init_infra_snowflake.setup_data_warehouse" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_data_warehouse
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links" class="md-nav__link">
    <span class="md-ellipsis">
      
        scrape_links
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="scrape_links">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links.get_parquet_links" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_parquet_links
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links.get_scraping_year" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_scraping_year
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links.get_xpath" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_xpath
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.scrape_links.setup_meta_table" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_meta_table
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.upload_stage" class="md-nav__link">
    <span class="md-ellipsis">
      
        upload_stage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="upload_stage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.upload_stage.download_and_upload_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        download_and_upload_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.upload_stage.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_to_table
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_to_table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.cleanup_stage_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        cleanup_stage_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.copy_file_to_table_and_count" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_file_to_table_and_count
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.create_table" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.handle_loading_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        handle_loading_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.load_to_table.update_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_metadata
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.backup_policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        backup_policy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="backup_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.backup_policy.create_and_set_backup" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_and_set_backup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.backup_policy.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_connect_with_role_autocommit_enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_connect_with_role_autocommit_enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_connect_with_role_parameters_passed_correctly" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_connect_with_role_parameters_passed_correctly
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_connect_with_role_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_connect_with_role_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_run_sql_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_run_sql_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_run_sql_file_multiple_statements" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_run_sql_file_multiple_statements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_run_sql_file_variable_not_found" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_run_sql_file_variable_not_found
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_use_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_use_context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_functions.test_use_context_exception" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_use_context_exception
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_init_infra_snowflake
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_init_infra_snowflake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_create_roles_and_user" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_create_roles_and_user
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_grant_privileges" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_grant_privileges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_main_exception" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_exception
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_main_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_set_data_retention" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_set_data_retention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_init_infra_snowflake.test_setup_data_warehouse" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_setup_data_warehouse
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_scrape_links
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_scrape_links">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_parquet_links_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_parquet_links_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_empty_env_early_month" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_scraping_year_with_empty_env_early_month
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_empty_env_late_month" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_scraping_year_with_empty_env_late_month
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_invalid_env_early_month" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_scraping_year_with_invalid_env_early_month
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_invalid_env_late_month" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_scraping_year_with_invalid_env_late_month
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_valid_env" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_scraping_year_with_valid_env
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_get_xpath" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_get_xpath
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_main_file_parsing" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_file_parsing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_main_with_new_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_with_new_files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_main_without_new_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_without_new_files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_scrape_links.test_setup_meta_table" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_setup_meta_table
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_upload_stage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_upload_stage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_http_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_download_and_upload_file_http_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_snowflake_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_download_and_upload_file_snowflake_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_download_and_upload_file_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_tempfile_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_download_and_upload_file_tempfile_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_main_file_processing_flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_file_processing_flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_main_with_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_with_files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_upload_stage.test_main_with_upload_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_with_upload_error
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_load_to_table
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_load_to_table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_cleanup_stage_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_cleanup_stage_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_copy_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_copy_file_to_table_and_count_copy_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_copy_file_to_table_and_count_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_zero_loaded" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_copy_file_to_table_and_count_zero_loaded
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_create_table_no_schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_create_table_no_schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_create_table_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_create_table_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_handle_loading_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_handle_loading_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_complete_flow_with_counts" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_complete_flow_with_counts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_connection_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_connection_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_exception_handling_in_loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_exception_handling_in_loop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_multiple_files_different_results" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_multiple_files_different_results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_no_staged_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_no_staged_files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_success_flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_success_flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_table_creation_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_table_creation_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_main_with_loading_error" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_with_loading_error
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_load_to_table.test_update_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_update_metadata
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_backup_policy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_backup_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy.test_backup_configuration_values" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_backup_configuration_values
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy.test_create_and_set_backup" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_create_and_set_backup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy.test_main_exception" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_exception
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy.test_main_success" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_success
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snowflake_ingestion.tests.test_backup_policy.test_main_with_connection_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        test_main_with_connection_context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="docstrings-python">Docstrings Python</h1>


<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.functions" class="doc doc-heading">
            <code>snowflake_ingestion.functions</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.functions.config_logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">config_logger</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Configure the global logger.</p>
<p>Reads LOGGER_LEVEL from the module environment and configures the
root logging settings (level, format, date format). Intended to be
called once at application start.</p>
<p>No return value.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">config_logger</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure the global logger.</span>

<span class="sd">    Reads LOGGER_LEVEL from the module environment and configures the</span>
<span class="sd">    root logging settings (level, format, date format). Intended to be</span>
<span class="sd">    called once at application start.</span>

<span class="sd">    No return value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">LOGGER_LEVEL</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.functions.connect_with_role" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect_with_role</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a Snowflake connection using the specified credentials and role.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>user</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Snowflake username.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>password</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Snowflake password.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>account</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Snowflake account identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>role</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Snowflake role to assume for the session.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="snowflake.connector.SnowflakeConnection">SnowflakeConnection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>snowflake.connector.connection.SnowflakeConnection:
A Snowflake connection object with autocommit enabled.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>This function opens a network connection to Snowflake. The caller
is responsible for closing the connection when it is no longer needed.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">connect_with_role</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">snowflake</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">SnowflakeConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Snowflake connection using the specified credentials and role.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (str): Snowflake username.</span>
<span class="sd">        password (str): Snowflake password.</span>
<span class="sd">        account (str): Snowflake account identifier.</span>
<span class="sd">        role (str): Snowflake role to assume for the session.</span>

<span class="sd">    Returns:</span>
<span class="sd">        snowflake.connector.connection.SnowflakeConnection:</span>
<span class="sd">            A Snowflake connection object with autocommit enabled.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This function opens a network connection to Snowflake. The caller</span>
<span class="sd">        is responsible for closing the connection when it is no longer needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">snowflake</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
        <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.functions.plural_suffix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plural_suffix</span><span class="p">(</span><span class="n">count</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Return 's' if count is greater than or equal to 2, else return an empty string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>count</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of items.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>'s' if count &gt;= 2, else ''.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">plural_suffix</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plural_suffix</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plural_suffix</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">&#39;s&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plural_suffix</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">&#39;s&#39;</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plural_suffix</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return &#39;s&#39; if count is greater than or equal to 2, else return an empty string.</span>

<span class="sd">    Args:</span>
<span class="sd">        count (int): The number of items.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: &#39;s&#39; if count &gt;= 2, else &#39;&#39;.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; plural_suffix(0)</span>
<span class="sd">        &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; plural_suffix(1)</span>
<span class="sd">        &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; plural_suffix(2)</span>
<span class="sd">        &#39;s&#39;</span>
<span class="sd">        &gt;&gt;&gt; plural_suffix(3)</span>
<span class="sd">        &#39;s&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.functions.run_sql_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute SQL statements from a file using VAR_PLACEHOLDER placeholders.</p>


<details class="the-function" open>
  <summary>The function</summary>
  <ul>
<li>Reads the SQL file.</li>
<li>Finds placeholders in the form VAR_PLACEHOLDER (captures VAR).</li>
<li>Replaces each found placeholder with the value of the corresponding
  global variable named VAR (stringified).</li>
<li>Masks variables containing "PASSWORD" in logger output.</li>
<li>Splits the file by semicolons and executes non-empty statements.</li>
</ul>
</details>

<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filepath</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the SQL file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>Placeholders that do not match a global variable are replaced with
a string of the form <code>&lt;VAR_NOT_FOUND&gt;</code>.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">snowflake</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SQL statements from a file using VAR_PLACEHOLDER placeholders.</span>

<span class="sd">    The function:</span>
<span class="sd">      - Reads the SQL file.</span>
<span class="sd">      - Finds placeholders in the form VAR_PLACEHOLDER (captures VAR).</span>
<span class="sd">      - Replaces each found placeholder with the value of the corresponding</span>
<span class="sd">        global variable named VAR (stringified).</span>
<span class="sd">      - Masks variables containing &quot;PASSWORD&quot; in logger output.</span>
<span class="sd">      - Splits the file by semicolons and executes non-empty statements.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active cursor.</span>
<span class="sd">        filepath (pathlib.Path or str): Path to the SQL file.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Placeholders that do not match a global variable are replaced with</span>
<span class="sd">        a string of the form `&lt;VAR_NOT_FOUND&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:SCHEMA_)?(\w+)_PLACEHOLDER&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_NOT_FOUND&gt;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîé Variables d√©tect√©es dans </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_PLACEHOLDER&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">masked_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s2">&quot;*****&quot;</span> <span class="k">if</span> <span class="s2">&quot;PASSWORD&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variables utilis√©es : </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">masked_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">statement</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.functions.use_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">use_context</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">WH_NAME</span><span class="p">,</span> <span class="n">DW_NAME</span><span class="p">,</span> <span class="n">RAW_SCHEMA</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set the Snowflake session context: warehouse, database and schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>WH_NAME</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Warehouse name to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>DW_NAME</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database name to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>RAW_SCHEMA</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema name to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="SystemExit">SystemExit</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exits the process on any exception when setting the context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">use_context</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">snowflake</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">WH_NAME</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">DW_NAME</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">RAW_SCHEMA</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the Snowflake session context: warehouse, database and schema.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">        WH_NAME (str): Warehouse name to use.</span>
<span class="sd">        DW_NAME (str): Database name to use.</span>
<span class="sd">        RAW_SCHEMA (str): Schema name to use.</span>

<span class="sd">    Raises:</span>
<span class="sd">        SystemExit: Exits the process on any exception when setting the context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚öôÔ∏è Configuration du contexte: WH=</span><span class="si">{</span><span class="n">WH_NAME</span><span class="si">}</span><span class="s2">, DB=</span><span class="si">{</span><span class="n">DW_NAME</span><span class="si">}</span><span class="s2">, SCHEMA=SCHEMA_</span><span class="si">{</span><span class="n">RAW_SCHEMA</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USE WAREHOUSE </span><span class="si">{</span><span class="n">WH_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USE DATABASE </span><span class="si">{</span><span class="n">DW_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USE SCHEMA SCHEMA_</span><span class="si">{</span><span class="n">RAW_SCHEMA</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;‚ùå Erreur : Relancer l&#39;√©tape Snowflake Infra Init&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.init_infra_snowflake" class="doc doc-heading">
            <code>snowflake_ingestion.init_infra_snowflake</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.init_infra_snowflake.create_roles_and_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_roles_and_user</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create the DBT role and user in Snowflake.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_roles_and_user</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the DBT role and user in Snowflake.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üîê Creating roles and users...&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_roles_and_user.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Roles and users created&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.init_infra_snowflake.grant_privileges" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">grant_privileges</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Grant required privileges to the TRANSFORMER role in Snowflake.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">grant_privileges</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grant required privileges to the TRANSFORMER role in Snowflake.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üîë Granting privileges to the roles...&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;grant_privileges.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Privileges granted&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.init_infra_snowflake.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main initialization process for the Snowflake environment.</p>
<p>Establishes connections with appropriate roles (SYSADMIN, SECURITYADMIN, ACCOUNTADMIN)
and executes setup steps in order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main initialization process for the Snowflake environment.</span>

<span class="sd">    Establishes connections with appropriate roles (SYSADMIN, SECURITYADMIN, ACCOUNTADMIN)</span>
<span class="sd">    and executes setup steps in order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s2">&quot;SYSADMIN&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">setup_data_warehouse</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s2">&quot;SECURITYADMIN&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">create_roles_and_user</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="n">grant_privileges</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s2">&quot;ACCOUNTADMIN&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">set_data_retention</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üéØ Complete initialization finished successfully!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.init_infra_snowflake.set_data_retention" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_data_retention</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set the data retention period for the Snowflake account.</p>
<p>Checks if the account is Enterprise, then applies the retention time.
Logs the result in days, with pluralization handled automatically.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data_retention</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the data retention period for the Snowflake account.</span>

<span class="sd">    Checks if the account is Enterprise, then applies the retention time.</span>
<span class="sd">    Logs the result in days, with pluralization handled automatically.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üèóÔ∏è  Setting up data retention&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;set_data_retention.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">plural_suffix</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">RETENTION_TIME</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Data retention set to </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RETENTION_TIME</span><span class="si">}</span><span class="s2"> day</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.init_infra_snowflake.setup_data_warehouse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_data_warehouse</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create the data warehouse, database, and schemas in Snowflake.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_data_warehouse</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the data warehouse, database, and schemas in Snowflake.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üèóÔ∏è  Creating warehouse, database and schemas...&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;setup_data_warehouse.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Warehouse and schemas created&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.scrape_links" class="doc doc-heading">
            <code>snowflake_ingestion.scrape_links</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.scrape_links.get_parquet_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_parquet_links</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Scrape the NYC Taxi data page for Parquet file URLs.
Sends an HTTP request to the NYC Taxi,parses the page HTML,
and extracts links to Parquet files for the relevant years.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]: List of Parquet file URLs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_parquet_links</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scrape the NYC Taxi data page for Parquet file URLs.</span>
<span class="sd">    Sends an HTTP request to the NYC Taxi,parses the page HTML,</span>
<span class="sd">    and extracts links to Parquet files for the relevant years.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[str]: List of Parquet file URLs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üåê Starting NYC Taxi data scraping&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scraping_url</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">xpath_query</span> <span class="o">=</span> <span class="n">get_xpath</span><span class="p">()</span>
    <span class="n">filtered_links</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">xpath_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">filtered_links</span>
        <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.scrape_links.get_scraping_year" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_scraping_year</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Determine the scraping year to use based on environment settings.
Uses SCRAPING_YEAR if defined and valid, otherwise selects the previous
year when current month ‚â§ 3, or the current year otherwise.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The year to scrape.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Doctests:
from functions import SCRAPING_YEAR</p>
<blockquote>
<blockquote>
<blockquote>
<p>get_scraping_year() == (int(SCRAPING_YEAR) if SCRAPING_YEAR != '' else current_year) - int(current_month &lt;= 3)
True</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_scraping_year</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the scraping year to use based on environment settings.</span>
<span class="sd">    Uses SCRAPING_YEAR if defined and valid, otherwise selects the previous</span>
<span class="sd">    year when current month ‚â§ 3, or the current year otherwise.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The year to scrape.</span>

<span class="sd">    Doctests:</span>
<span class="sd">    from functions import SCRAPING_YEAR</span>
<span class="sd">    &gt;&gt;&gt; get_scraping_year() == (int(SCRAPING_YEAR) if SCRAPING_YEAR != &#39;&#39; else current_year) - int(current_month &lt;= 3)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_year</span> <span class="o">=</span> <span class="n">current_year</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">current_month</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">current_year</span>
    <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">SCRAPING_YEAR</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_year</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">int_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">SCRAPING_YEAR</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">SCRAPING_YEAR = </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">SCRAPING_YEAR</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> is not a valid year!&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scraping year has been reset to </span><span class="si">{</span><span class="n">default_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default_year</span>

        <span class="k">if</span> <span class="n">int_year</span> <span class="o">&lt;</span> <span class="mi">2009</span> <span class="ow">or</span> <span class="n">int_year</span> <span class="o">&gt;</span> <span class="n">current_year</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">SCRAPING_YEAR = </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">SCRAPING_YEAR</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> scraping year must be between 2009 and </span><span class="si">{</span><span class="n">current_year</span><span class="si">}</span><span class="s2"> inclusive!&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scraping year has been reset to </span><span class="si">{</span><span class="n">default_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default_year</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Files will be scraped from year </span><span class="si">{</span><span class="n">default_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">int_year</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.scrape_links.get_xpath" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_xpath</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Build the XPath expression used to locate Parquet file links.
The expression filters NYC Taxi data links by year, starting from the
scraping year up to the current year.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>XPath query string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_xpath</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the XPath expression used to locate Parquet file links.</span>
<span class="sd">    The expression filters NYC Taxi data links by year, starting from the</span>
<span class="sd">    scraping year up to the current year.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: XPath query string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xpath_query</span> <span class="o">=</span> <span class="s2">&quot;//a[@title=&#39;Yellow Taxi Trip Records&#39; and (&quot;</span>
    <span class="n">get_contains</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">year</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;contains(@href, &#39;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
    <span class="n">contains_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_contains</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">get_scraping_year</span><span class="p">(),</span> <span class="n">current_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">xpath_query</span> <span class="o">+=</span> <span class="s2">&quot; or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contains_list</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)]&quot;</span>
    <span class="k">return</span> <span class="n">xpath_query</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.scrape_links.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main scraping and metadata update workflow.
Connects to Snowflake using the transformer role, initializes context,
checks or creates the metadata table, scrapes new file URLs, and updates
the metadata accordingly.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main scraping and metadata update workflow.</span>
<span class="sd">    Connects to Snowflake using the transformer role, initializes context,</span>
<span class="sd">    checks or creates the metadata table, scrapes new file URLs, and updates</span>
<span class="sd">    the metadata accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">USER_DEV</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD_DEV</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">ROLE_TRANSFORMER</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">use_context</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">WH_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">DW_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">RAW_SCHEMA</span><span class="p">)</span>
        <span class="n">setup_meta_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">get_parquet_links</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">plural_suffix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìé </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="si">}</span><span class="s2"> link</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> found&quot;</span><span class="p">)</span>
        <span class="n">new_file_detected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SELECT 1 FROM </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2"> WHERE file_name = %s&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">filename</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ûï New file detected : </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">new_file_detected</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">parts</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;yellow_tripdata_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    INSERT INTO </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span>
<span class="s2">                    (file_url, file_name, year, month, rows_loaded, load_status)</span>
<span class="s2">                    VALUES (%s, %s, %s, %s, 0, &#39;SCRAPED&#39;)</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚è≠Ô∏è  </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> already referenced&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_file_detected</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;üîç Analyzing SCRAPED files&quot;</span><span class="p">)</span>
                <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;count_new_files.sql&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_file_detected</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_file_detected</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è  No new files to load.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Scraping completed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.scrape_links.setup_meta_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_meta_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Ensure the metadata table exists in Snowflake.
Executes the SQL script responsible for creating or verifying the
metadata table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_meta_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure the metadata table exists in Snowflake.</span>
<span class="sd">    Executes the SQL script responsible for creating or verifying the</span>
<span class="sd">    metadata table.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üìã Verification/Creation of metadata table&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;setup_meta_table.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Metadata table ready&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.upload_stage" class="doc doc-heading">
            <code>snowflake_ingestion.upload_stage</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.upload_stage.download_and_upload_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Download a Parquet file from URL and upload it directly to Snowflake stage.</p>
<p>This function streams the file content directly to Snowflake without persisting
it permanently on disk. It uses a temporary file that is automatically deleted
after the upload completes, ensuring no residual files are left behind.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor 
used to execute the PUT command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTPS URL of the Parquet file to download.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Destination filename in the Snowflake stage.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="requests.HTTPError">HTTPError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the HTTP request fails (non-200 status code).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="snowflake.connector.errors.Error">Error</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the Snowflake PUT command fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_and_upload_file</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">file_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download a Parquet file from URL and upload it directly to Snowflake stage.</span>

<span class="sd">    This function streams the file content directly to Snowflake without persisting</span>
<span class="sd">    it permanently on disk. It uses a temporary file that is automatically deleted</span>
<span class="sd">    after the upload completes, ensuring no residual files are left behind.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor </span>
<span class="sd">            used to execute the PUT command.</span>
<span class="sd">        file_url (str): HTTPS URL of the Parquet file to download.</span>
<span class="sd">        filename (str): Destination filename in the Snowflake stage.</span>

<span class="sd">    Raises:</span>
<span class="sd">        requests.HTTPError: If the HTTP request fails (non-200 status code).</span>
<span class="sd">        snowflake.connector.errors.Error: If the Snowflake PUT command fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üì• Downloading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
        <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">tmp_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üì§ Uploading to Snowflake...&quot;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PUT &#39;file://</span><span class="si">{</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; @~/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> AUTO_COMPRESS=FALSE&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> uploaded and temporary file cleaned&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.upload_stage.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main staging process for Parquet files.</p>
<p>Connects to Snowflake, retrieves metadata for scraped files, downloads
each file, uploads it to the stage, and updates the metadata table
with the appropriate load status.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main staging process for Parquet files.</span>

<span class="sd">    Connects to Snowflake, retrieves metadata for scraped files, downloads</span>
<span class="sd">    each file, uploads it to the stage, and updates the metadata table</span>
<span class="sd">    with the appropriate load status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">USER_DEV</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD_DEV</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">ROLE_TRANSFORMER</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">use_context</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">WH_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">DW_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">RAW_SCHEMA</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;üì• Retrieving scraped file URLs and names&quot;</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;select_file_url_name_from_meta_scraped.sql&quot;</span><span class="p">)</span>
        <span class="n">scraped_files</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">scraped_files_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scraped_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scraped_files_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è  No files to upload&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üì¶ </span><span class="si">{</span><span class="n">scraped_files_count</span><span class="si">}</span><span class="s2"> files to upload&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_url</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">scraped_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> uploaded&quot;</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2"> SET load_status=&#39;STAGED&#39; WHERE file_name=%s&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">filename</span><span class="p">,),</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Upload error </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2"> SET load_status=&#39;FAILED_STAGE&#39; WHERE file_name=%s&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">filename</span><span class="p">,),</span>
                <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.load_to_table" class="doc doc-heading">
            <code>snowflake_ingestion.load_to_table</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.cleanup_stage_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cleanup_stage_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Remove the processed file from the Snowflake stage.
Args:
    cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.
    filename (str): Name of the file to delete from the stage.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cleanup_stage_file</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the processed file from the Snowflake stage.</span>
<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">        filename (str): Name of the file to delete from the stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;REMOVE @~/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> removed from stage&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.copy_file_to_table_and_count" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load a Parquet file from stage into the RAW table and count inserted rows.
Uses COPY INTO with transformation to generate TRIP_ID using sequence and 
maps Parquet columns using positional references.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the staged file to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_schema</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pre-detected schema from create_table function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows inserted into the RAW table.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a Parquet file from stage into the RAW table and count inserted rows.</span>
<span class="sd">    Uses COPY INTO with transformation to generate TRIP_ID using sequence and </span>
<span class="sd">    maps Parquet columns using positional references.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">        filename (str): Name of the staged file to load.</span>
<span class="sd">        table_schema (list): Pre-detected schema from create_table function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of rows inserted into the RAW table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;airport_fee&quot;</span><span class="p">,</span> <span class="s2">&quot;Airport_fee&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_schema</span><span class="p">]</span>
    <span class="n">select_columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;$1:</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>
    <span class="n">copy_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        COPY INTO </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2"> (TRIP_ID, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span><span class="si">}</span><span class="s2">, FILENAME)</span>
<span class="s2">        FROM (</span>
<span class="s2">            SELECT </span>
<span class="s2">                </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">ID_SEQUENCE</span><span class="si">}</span><span class="s2">.NEXTVAL,</span>
<span class="s2">                </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">            FROM &#39;@~/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        )</span>
<span class="s2">        FILE_FORMAT=(FORMAT_NAME=&#39;</span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">DW_NAME</span><span class="si">}</span><span class="s2">.SCHEMA_</span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_SCHEMA</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">PARQUET_FORMAT</span><span class="si">}</span><span class="s2">&#39;)</span>
<span class="s2">        FORCE = TRUE</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">copy_sql</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">rows_loaded</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rows_loaded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">plural_suffix</span><span class="p">(</span><span class="n">rows_loaded</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> loaded (</span><span class="si">{</span><span class="n">rows_loaded</span><span class="si">}</span><span class="s2"> row</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rows_loaded</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.create_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create or verify the RAW table dynamically based on staged file schema.
Executes SQL to detect the file schema in the Snowflake stage,
creates the RAW table if it does not exist, and adds the filename
column if needed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The table schema detected from staged files</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create or verify the RAW table dynamically based on staged file schema.</span>
<span class="sd">    Executes SQL to detect the file schema in the Snowflake stage,</span>
<span class="sd">    creates the RAW table if it does not exist, and adds the filename</span>
<span class="sd">    column if needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: The table schema detected from staged files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìã Dynamic verification/creation of table </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;detect_file_schema_stage.sql&quot;</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">table_schema</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">table_schema</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_schema</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è  No data in STAGE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table_schema</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_sequence.sql&quot;</span><span class="p">)</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;TRIP_ID NUMBER&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">table_schema</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">create_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CREATE TABLE IF NOT EXISTS </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_sql</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;add_filename_to_raw_table.sql&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Table </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2"> ready&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è  No data in STAGE&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table_schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.handle_loading_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_loading_error</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle errors occurring during file loading into the RAW table.
Logs the error and updates the metadata table to mark the file
as failed during the load step.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the file that failed to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>error</code>
            </td>
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception raised during the loading process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_loading_error</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle errors occurring during file loading into the RAW table.</span>
<span class="sd">    Logs the error and updates the metadata table to mark the file</span>
<span class="sd">    as failed during the load step.</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">        filename (str): Name of the file that failed to load.</span>
<span class="sd">        error (Exception): Exception raised during the loading process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Loading error </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2"> SET load_status=&#39;FAILED_LOAD&#39; WHERE file_name=%s&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">filename</span><span class="p">,),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main process for loading staged Parquet files into the RAW table.
Connects to Snowflake, ensures the RAW table exists, retrieves staged files,
loads each into the RAW table, updates metadata, and cleans up stage files.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main process for loading staged Parquet files into the RAW table.</span>
<span class="sd">    Connects to Snowflake, ensures the RAW table exists, retrieves staged files,</span>
<span class="sd">    loads each into the RAW table, updates metadata, and cleans up stage files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">USER_DEV</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD_DEV</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ROLE_TRANSFORMER</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">use_context</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">WH_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">DW_NAME</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">RAW_SCHEMA</span><span class="p">)</span>
        <span class="n">table_schema</span> <span class="o">=</span> <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üîç Analyzing files in STAGE&quot;</span><span class="p">)</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;select_filename_from_meta_staged.sql&quot;</span><span class="p">)</span>
        <span class="n">staged_files</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">staged_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rows_loaded</span> <span class="o">=</span> <span class="n">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">)</span>
                <span class="n">update_metadata</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rows_loaded</span><span class="p">)</span>
                <span class="n">cleanup_stage_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">handle_loading_error</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.load_to_table.update_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_metadata</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rows_loaded</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Update the metadata table after successful file loading.
Args:
    cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.
    filename (str): Name of the loaded file.
    rows_loaded (int): Number of rows successfully inserted.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_metadata</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rows_loaded</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the metadata table after successful file loading.</span>
<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">        filename (str): Name of the loaded file.</span>
<span class="sd">        rows_loaded (int): Number of rows successfully inserted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        UPDATE </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">        SET rows_loaded = %s, load_status = &#39;SUCCESS&#39; </span>
<span class="s2">        WHERE file_name = %s</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">rows_loaded</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.backup_policy" class="doc doc-heading">
            <code>snowflake_ingestion.backup_policy</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.backup_policy.create_and_set_backup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_and_set_backup</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Creates the backup policies and backup sets for the data warehouse.</p>
<p>Executes the SQL script to create the monthly backup policies and
link them to the target objects (full database, raw table, final schema).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cur</code>
            </td>
            <td>
                  <code><span title="snowflake.connector.cursor.SnowflakeCursor">SnowflakeCursor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Active Snowflake cursor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_and_set_backup</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">SnowflakeCursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the backup policies and backup sets for the data warehouse.</span>

<span class="sd">    Executes the SQL script to create the monthly backup policies and</span>
<span class="sd">    link them to the target objects (full database, raw table, final schema).</span>

<span class="sd">    Args:</span>
<span class="sd">        cur (snowflake.connector.cursor.SnowflakeCursor): Active Snowflake cursor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üîê Creating backup policies and sets...&quot;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_and_set_backup.sql&quot;</span>
    <span class="n">functions</span><span class="o">.</span><span class="n">run_sql_file</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">sql_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">DW_NAME</span><span class="si">}</span><span class="s2">_BACKUP retention : </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">FULL_BACKUP_POLICY_DAYS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2">_BACKUP retention : </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE_BACKUP_POLICY_DAYS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">FINAL_SCHEMA</span><span class="si">}</span><span class="s2">_BACKUP retention : </span><span class="si">{</span><span class="n">functions</span><span class="o">.</span><span class="n">FINAL_SCHEMA_BACKUP_POLICY_DAYS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.backup_policy.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main initialization process for the Snowflake environment.</p>
<p>Establishes connections with appropriate roles (SYSADMIN, SECURITYADMIN, ACCOUNTADMIN)
and executes setup steps in order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main initialization process for the Snowflake environment.</span>

<span class="sd">    Establishes connections with appropriate roles (SYSADMIN, SECURITYADMIN, ACCOUNTADMIN)</span>
<span class="sd">    and executes setup steps in order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">connect_with_role</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s2">&quot;SYSADMIN&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">create_and_set_backup</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üéØ Complete initialization finished successfully!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_functions" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_functions</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_connect_with_role_autocommit_enabled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_connect_with_role_autocommit_enabled</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire v√©rifiant que l'autocommit est toujours activ√©.
V√©rifie que le param√®tre autocommit=True est syst√©matiquement pass√©
√† la connexion Snowflake, ind√©pendamment des autres param√®tres.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_with_role_autocommit_enabled</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire v√©rifiant que l&#39;autocommit est toujours activ√©.</span>
<span class="sd">    V√©rifie que le param√®tre autocommit=True est syst√©matiquement pass√©</span>
<span class="sd">    √† la connexion Snowflake, ind√©pendamment des autres param√®tres.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_connection</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.snowflake.connector.connect&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_connection</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="n">connect_with_role</span><span class="p">(</span><span class="s2">&quot;different_user&quot;</span><span class="p">,</span> <span class="s2">&quot;different_pass&quot;</span><span class="p">,</span> <span class="s2">&quot;different_account&quot;</span><span class="p">,</span> <span class="s2">&quot;different_role&quot;</span><span class="p">)</span>
        <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">mock_connect</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span>
        <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s1">&#39;autocommit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_connect_with_role_parameters_passed_correctly" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_connect_with_role_parameters_passed_correctly</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire v√©rifiant la transmission correcte des param√®tres.
V√©rifie que tous les param√®tres (user, password, account, role) sont
correctement transmis √† snowflake.connector.connect sans modification.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_with_role_parameters_passed_correctly</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire v√©rifiant la transmission correcte des param√®tres.</span>
<span class="sd">    V√©rifie que tous les param√®tres (user, password, account, role) sont</span>
<span class="sd">    correctement transmis √† snowflake.connector.connect sans modification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_connection</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.snowflake.connector.connect&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_connection</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="n">test_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;test_user&#39;</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;test_password&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;account&#39;</span><span class="p">:</span> <span class="s1">&#39;test_account&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;test_role&#39;</span>
        <span class="p">}</span>
        <span class="n">connect_with_role</span><span class="p">(</span><span class="o">**</span><span class="n">test_params</span><span class="p">)</span>
        <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">mock_connect</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">test_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
        <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s1">&#39;autocommit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_connect_with_role_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_connect_with_role_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de connect_with_role en cas de succ√®s.
V√©rifie que la fonction appelle snowflake.connector.connect avec les bons
param√®tres, active l'autocommit et retourne l'objet connexion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_with_role_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de connect_with_role en cas de succ√®s.</span>
<span class="sd">    V√©rifie que la fonction appelle snowflake.connector.connect avec les bons</span>
<span class="sd">    param√®tres, active l&#39;autocommit et retourne l&#39;objet connexion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_connection</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.snowflake.connector.connect&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_connection</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connect_with_role</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">,</span> <span class="s2">&quot;account&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span>
        <span class="n">mock_connect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span><span class="p">,</span> 
            <span class="n">account</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;role&quot;</span><span class="p">,</span>
            <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">mock_connection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_run_sql_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_run_sql_file</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de la fonction run_sql_file avec substitution de variables.
V√©rifie que les placeholders dans le SQL sont correctement remplac√©s
par les valeurs des variables globales correspondantes.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_run_sql_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de la fonction run_sql_file avec substitution de variables.</span>
<span class="sd">    V√©rifie que les placeholders dans le SQL sont correctement remplac√©s</span>
<span class="sd">    par les valeurs des variables globales correspondantes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">sql_content</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM RAW_TABLE_PLACEHOLDER WHERE user = USER_PLACEHOLDER;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">sql_content</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.RAW_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;my_table&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.USER&#39;</span><span class="p">,</span> <span class="s1">&#39;test_user&#39;</span><span class="p">):</span>
                <span class="n">run_sql_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;test.sql&quot;</span><span class="p">))</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM my_table WHERE user = test_user&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_run_sql_file_multiple_statements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_run_sql_file_multiple_statements</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de run_sql_file avec multiples requ√™tes.
V√©rifie que les requ√™tes s√©par√©es par des points-virgules sont
correctement divis√©es et ex√©cut√©es individuellement.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_run_sql_file_multiple_statements</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de run_sql_file avec multiples requ√™tes.</span>
<span class="sd">    V√©rifie que les requ√™tes s√©par√©es par des points-virgules sont</span>
<span class="sd">    correctement divis√©es et ex√©cut√©es individuellement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">sql_content</span> <span class="o">=</span> <span class="s2">&quot;SELECT 1; SELECT 2; SELECT 3;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">sql_content</span><span class="p">)):</span>
        <span class="n">run_sql_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;test.sql&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_run_sql_file_variable_not_found" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_run_sql_file_variable_not_found</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de run_sql_file avec variable non trouv√©e.
V√©rifie que les placeholders sans variable globale correspondante
sont remplac√©s par la valeur par d√©faut <VAR_NOT_FOUND>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_run_sql_file_variable_not_found</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de run_sql_file avec variable non trouv√©e.</span>
<span class="sd">    V√©rifie que les placeholders sans variable globale correspondante</span>
<span class="sd">    sont remplac√©s par la valeur par d√©faut &lt;VAR_NOT_FOUND&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">sql_content</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM UNKNOWN_PLACEHOLDER;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">sql_content</span><span class="p">)):</span>
        <span class="n">run_sql_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;test.sql&quot;</span><span class="p">))</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM &lt;UNKNOWN_NOT_FOUND&gt;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_use_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_use_context</span><span class="p">(</span><span class="n">mocker</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de la fonction use_context.
V√©rifie que la fonction ex√©cute les 3 commandes SQL attendues pour configurer
le contexte Snowflake (warehouse, database, schema) dans le bon ordre.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mocker</code>
            </td>
            <td>
                  <code><span title="unittest.mock.Mock">Mock</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fixture pytest pour le mocking</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_use_context</span><span class="p">(</span><span class="n">mocker</span><span class="p">:</span> <span class="n">Mock</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de la fonction use_context.</span>
<span class="sd">    V√©rifie que la fonction ex√©cute les 3 commandes SQL attendues pour configurer</span>
<span class="sd">    le contexte Snowflake (warehouse, database, schema) dans le bon ordre.</span>

<span class="sd">    Args:</span>
<span class="sd">        mocker: Fixture pytest pour le mocking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_execute</span><span class="p">:</span>
        <span class="n">use_context</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;WH&quot;</span><span class="p">,</span> <span class="s2">&quot;DB&quot;</span><span class="p">,</span> <span class="s2">&quot;TEST&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mock_execute</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_execute</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s2">&quot;USE WAREHOUSE WH&quot;</span> <span class="ow">in</span> <span class="n">calls</span>
        <span class="k">assert</span> <span class="s2">&quot;USE DATABASE DB&quot;</span> <span class="ow">in</span> <span class="n">calls</span>  
        <span class="k">assert</span> <span class="s2">&quot;USE SCHEMA SCHEMA_TEST&quot;</span> <span class="ow">in</span> <span class="n">calls</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_functions.test_use_context_exception" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_use_context_exception</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test unitaire de la gestion d'erreur de use_context.
V√©rifie que la fonction l√®ve une exception SystemExit lorsqu'une erreur
se produit lors de l'ex√©cution des commandes SQL.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_use_context_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unitaire de la gestion d&#39;erreur de use_context.</span>
<span class="sd">    V√©rifie que la fonction l√®ve une exception SystemExit lorsqu&#39;une erreur</span>
<span class="sd">    se produit lors de l&#39;ex√©cution des commandes SQL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DB error&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">SystemExit</span><span class="p">):</span>
        <span class="n">use_context</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;WH&quot;</span><span class="p">,</span> <span class="s2">&quot;DB&quot;</span><span class="p">,</span> <span class="s2">&quot;SCHEMA&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_init_infra_snowflake" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_init_infra_snowflake</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_create_roles_and_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_create_roles_and_user</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the create_roles_and_user function.
Tests the creation of Snowflake roles and users as part of infrastructure initialization.
Verifies that the appropriate SQL script is executed and success/failure logs are properly
recorded during the role and user creation process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_roles_and_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the create_roles_and_user function.</span>
<span class="sd">    Tests the creation of Snowflake roles and users as part of infrastructure initialization.</span>
<span class="sd">    Verifies that the appropriate SQL script is executed and success/failure logs are properly</span>
<span class="sd">    recorded during the role and user creation process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">infra</span><span class="o">.</span><span class="n">create_roles_and_user</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

            <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_roles_and_user.sql&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üîê Creating roles and users...&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ Roles and users created&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_grant_privileges" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_grant_privileges</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the grant_privileges function.
Tests the granting of privileges to the created roles in Snowflake.
Verifies that the correct SQL script is executed and appropriate log messages are recorded
during the privilege granting process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_grant_privileges</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the grant_privileges function.</span>
<span class="sd">    Tests the granting of privileges to the created roles in Snowflake.</span>
<span class="sd">    Verifies that the correct SQL script is executed and appropriate log messages are recorded</span>
<span class="sd">    during the privilege granting process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">infra</span><span class="o">.</span><span class="n">grant_privileges</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

            <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;grant_privileges.sql&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üîë Granting privileges to the roles...&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ Privileges granted&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_main_exception" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_exception</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the main function when an exception occurs during initialization.
Tests error handling by simulating a connection failure and verifying that the
exception is properly caught and logged as an error.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the main function when an exception occurs during initialization.</span>
<span class="sd">    Tests error handling by simulating a connection failure and verifying that the</span>
<span class="sd">    exception is properly caught and logged as an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection failed&quot;</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">infra</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_main_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the main function when the infrastructure initialization completes successfully.
Tests the complete initialization flow including warehouse setup, role creation,
and privilege granting. Verifies that all three connections are made with the
appropriate roles (ACCOUNTADMIN, SYSADMIN, SECURITYADMIN) and that all
initialization functions are called in sequence with successful logging.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the main function when the infrastructure initialization completes successfully.</span>
<span class="sd">    Tests the complete initialization flow including warehouse setup, role creation,</span>
<span class="sd">    and privilege granting. Verifies that all three connections are made with the</span>
<span class="sd">    appropriate roles (ACCOUNTADMIN, SYSADMIN, SECURITYADMIN) and that all</span>
<span class="sd">    initialization functions are called in sequence with successful logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Mock</span><span class="p">(),</span> <span class="n">Mock</span><span class="p">(),</span> <span class="n">Mock</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">mock_conn</span> <span class="ow">in</span> <span class="n">mock_conns</span><span class="p">:</span>
        <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
        <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">call_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_side_effect</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">call_counter</span>
        <span class="k">if</span> <span class="n">call_counter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mock_conns</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">mock_conns</span><span class="p">[</span><span class="n">call_counter</span><span class="p">]</span>
            <span class="n">call_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.RETENTION_TIME&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.connect_with_role&#39;</span><span class="p">,</span> 
                   <span class="n">side_effect</span><span class="o">=</span><span class="n">connect_side_effect</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.setup_data_warehouse&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_setup</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.create_roles_and_user&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_create</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.grant_privileges&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_grant</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                            <span class="n">infra</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

                            <span class="k">assert</span> <span class="n">mock_connect</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
                            <span class="n">mock_connect</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s1">&#39;ACCOUNTADMIN&#39;</span><span class="p">)</span>
                            <span class="n">mock_connect</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s1">&#39;SYSADMIN&#39;</span><span class="p">)</span>
                            <span class="n">mock_connect</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span> <span class="s1">&#39;SECURITYADMIN&#39;</span><span class="p">)</span>

                            <span class="n">mock_setup</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                            <span class="n">mock_create</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                            <span class="n">mock_grant</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;üéØ Complete initialization finished successfully!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_set_data_retention" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_set_data_retention</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the set_data_retention function.
Verifies that the function executes the correct SQL file with the specified retention time
and logs appropriate messages when setting data retention policies.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_set_data_retention</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the set_data_retention function.</span>
<span class="sd">    Verifies that the function executes the correct SQL file with the specified retention time</span>
<span class="sd">    and logs appropriate messages when setting data retention policies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.RETENTION_TIME&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                <span class="n">infra</span><span class="o">.</span><span class="n">set_data_retention</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_init_infra_snowflake.test_setup_data_warehouse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_setup_data_warehouse</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the setup_data_warehouse function.
Tests the creation of warehouse, database, and schemas infrastructure in Snowflake.
Verifies that the correct SQL script is executed and appropriate log messages are recorded
during the warehouse setup process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_init_infra_snowflake.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_setup_data_warehouse</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for the setup_data_warehouse function.</span>
<span class="sd">    Tests the creation of warehouse, database, and schemas infrastructure in Snowflake.</span>
<span class="sd">    Verifies that the correct SQL script is executed and appropriate log messages are recorded</span>
<span class="sd">    during the warehouse setup process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.init_infra_snowflake.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">infra</span><span class="o">.</span><span class="n">setup_data_warehouse</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

            <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">infra</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;setup_data_warehouse.sql&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üèóÔ∏è  Creating warehouse, database and schemas...&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ Warehouse and schemas created&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_scrape_links" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_scrape_links</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_parquet_links_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_parquet_links_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test successful extraction of parquet file links from the NYC TLC website HTML content.
Verifies that only links with title 'Yellow Taxi Trip Records' are extracted and returned.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_parquet_links_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test successful extraction of parquet file links from the NYC TLC website HTML content.</span>
<span class="sd">    Verifies that only links with title &#39;Yellow Taxi Trip Records&#39; are extracted and returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_html_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;a title=&quot;Yellow Taxi Trip Records&quot; href=&quot;https://example.com/file1.parquet&quot;&gt;Link1&lt;/a&gt;</span>
<span class="s2">        &lt;a title=&quot;Yellow Taxi Trip Records&quot; href=&quot;https://example.com/file2.parquet&quot;&gt;Link2&lt;/a&gt;</span>
<span class="s2">        &lt;a title=&quot;Other Title&quot; href=&quot;https://example.com/file3.parquet&quot;&gt;Link3&lt;/a&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">mock_html_content</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

    <span class="n">mock_tree</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_link1</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_link1</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;https://example.com/file1.parquet&quot;</span>
    <span class="n">mock_link2</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_link2</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;https://example.com/file2.parquet&quot;</span>
    <span class="n">mock_tree</span><span class="o">.</span><span class="n">xpath</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_link1</span><span class="p">,</span> <span class="n">mock_link2</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.requests.get&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.html.fromstring&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_fromstring</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.get_xpath&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;//a[@title=&#39;Yellow Taxi Trip Records&#39;]&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                    <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
                    <span class="n">mock_fromstring</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_tree</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_parquet_links</span><span class="p">()</span>

                    <span class="n">mock_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page&quot;</span><span class="p">)</span>
                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;üåê Starting NYC Taxi data scraping&quot;</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;https://example.com/file1.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.com/file2.parquet&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_empty_env_early_month" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_scraping_year_with_empty_env_early_month</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test get_scraping_year behavior when SCRAPING_YEAR is empty and current month is early (January to March).
The function should default to the previous year since current year's data may not be fully available yet.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_scraping_year_with_empty_env_early_month</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test get_scraping_year behavior when SCRAPING_YEAR is empty and current month is early (January to March).</span>
<span class="sd">    The function should default to the previous year since current year&#39;s data may not be fully available yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.SCRAPING_YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.current_month&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_scraping_year</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">current_year</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_empty_env_late_month" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_scraping_year_with_empty_env_late_month</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test get_scraping_year behavior when SCRAPING_YEAR is empty and current month is late (April to December).
The function should default to the current year for scraping operations.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_scraping_year_with_empty_env_late_month</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test get_scraping_year behavior when SCRAPING_YEAR is empty and current month is late (April to December).</span>
<span class="sd">    The function should default to the current year for scraping operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.SCRAPING_YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.current_month&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_scraping_year</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">current_year</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_invalid_env_early_month" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_scraping_year_with_invalid_env_early_month</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test get_scraping_year behavior when SCRAPING_YEAR contains invalid non-numeric data in early months.
The function should log an error and default to the previous year while handling the invalid input gracefully.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_scraping_year_with_invalid_env_early_month</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test get_scraping_year behavior when SCRAPING_YEAR contains invalid non-numeric data in early months.</span>
<span class="sd">    The function should log an error and default to the previous year while handling the invalid input gracefully.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.SCRAPING_YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.current_month&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_scraping_year</span><span class="p">()</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">current_year</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_invalid_env_late_month" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_scraping_year_with_invalid_env_late_month</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test get_scraping_year behavior when SCRAPING_YEAR contains invalid non-numeric data in late months.
The function should log an error and default to the current year while handling the invalid input gracefully.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_scraping_year_with_invalid_env_late_month</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test get_scraping_year behavior when SCRAPING_YEAR contains invalid non-numeric data in late months.</span>
<span class="sd">    The function should log an error and default to the current year while handling the invalid input gracefully.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.SCRAPING_YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.current_month&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_scraping_year</span><span class="p">()</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">current_year</span>
                <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_scraping_year_with_valid_env" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_scraping_year_with_valid_env</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test that get_scraping_year correctly parses and returns a valid integer value from the SCRAPING_YEAR environment variable.
Verifies that when SCRAPING_YEAR is set to '2023', the function returns the integer 2023.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_scraping_year_with_valid_env</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that get_scraping_year correctly parses and returns a valid integer value from the SCRAPING_YEAR environment variable.</span>
<span class="sd">    Verifies that when SCRAPING_YEAR is set to &#39;2023&#39;, the function returns the integer 2023.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.SCRAPING_YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;2023&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_scraping_year</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">2023</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_get_xpath" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_get_xpath</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test that get_xpath generates the correct XPath expression for locating Yellow Taxi Trip Records links.
The XPath should include both the scraping year and current year to capture relevant data files.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_xpath</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that get_xpath generates the correct XPath expression for locating Yellow Taxi Trip Records links.</span>
<span class="sd">    The XPath should include both the scraping year and current year to capture relevant data files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.get_scraping_year&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">2023</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.current_year&#39;</span><span class="p">,</span> <span class="mi">2024</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_xpath</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;//a[@title=&#39;Yellow Taxi Trip Records&#39; and (contains(@href, &#39;2023&#39;) or contains(@href, &#39;2024&#39;))]&quot;</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_main_file_parsing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_file_parsing</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test that the main function correctly parses filename patterns to extract year and month components.
Verifies that URLs like 'yellow_tripdata_2023-07.parquet' are correctly parsed into (2023, 7) tuples.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_file_parsing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the main function correctly parses filename patterns to extract year and month components.</span>
<span class="sd">    Verifies that URLs like &#39;yellow_tripdata_2023-07.parquet&#39; are correctly parsed into (2023, 7) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.setup_meta_table&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.get_parquet_links&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_links</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.run_sql_file&#39;</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">):</span>
                            <span class="n">mock_links</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://example.com/yellow_tripdata_2023-07.parquet&quot;</span><span class="p">]</span>
                            <span class="n">scrape</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

                            <span class="n">insert_call</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;INSERT&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                                    <span class="n">insert_call</span> <span class="o">=</span> <span class="n">call</span>
                                    <span class="k">break</span>

                            <span class="k">assert</span> <span class="n">insert_call</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">assert</span> <span class="n">insert_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;https://example.com/yellow_tripdata_2023-07.parquet&quot;</span><span class="p">,</span> 
                                                        <span class="s2">&quot;yellow_tripdata_2023-07.parquet&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_main_with_new_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_with_new_files</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test the main scraping workflow when new parquet files are detected that don't exist in the metadata table.
Verifies that new files trigger INSERT operations into the metadata table with appropriate logging.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_with_new_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the main scraping workflow when new parquet files are detected that don&#39;t exist in the metadata table.</span>
<span class="sd">    Verifies that new files trigger INSERT operations into the metadata table with appropriate logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">]]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.setup_meta_table&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.get_parquet_links&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_links</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.run_sql_file&#39;</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>

                            <span class="n">mock_links</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="s2">&quot;https://example.com/yellow_tripdata_2023-01.parquet&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;https://example.com/yellow_tripdata_2023-02.parquet&quot;</span>
                            <span class="p">]</span>

                            <span class="n">scrape</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

                            <span class="k">assert</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_count</span> <span class="o">&gt;=</span> <span class="mi">4</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üìé 2 links found&quot;</span><span class="p">)</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚ûï New file detected : yellow_tripdata_2023-01.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_main_without_new_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_without_new_files</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test the main scraping workflow when all discovered parquet files already exist in the metadata table.
Verifies that no INSERT operations occur and appropriate informational and warning logs are recorded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_without_new_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the main scraping workflow when all discovered parquet files already exist in the metadata table.</span>
<span class="sd">    Verifies that no INSERT operations occur and appropriate informational and warning logs are recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.setup_meta_table&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.get_parquet_links&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_links</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.run_sql_file&#39;</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                            <span class="n">mock_links</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://example.com/yellow_tripdata_2023-01.parquet&quot;</span><span class="p">]</span>
                            <span class="n">scrape</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üìé 1 link found&quot;</span><span class="p">)</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚è≠Ô∏è  yellow_tripdata_2023-01.parquet already referenced&quot;</span><span class="p">)</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ Scraping completed&quot;</span><span class="p">)</span>
                            <span class="n">mock_logger</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è  No new files to load.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_scrape_links.test_setup_meta_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_setup_meta_table</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test that setup_meta_table correctly executes the SQL script for creating or verifying the metadata table.
Verifies that the appropriate SQL file is executed and success/failure logs are recorded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_scrape_links.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_setup_meta_table</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that setup_meta_table correctly executes the SQL script for creating or verifying the metadata table.</span>
<span class="sd">    Verifies that the appropriate SQL file is executed and success/failure logs are recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.scrape_links.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">scrape</span><span class="o">.</span><span class="n">setup_meta_table</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>
            <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">scrape</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;setup_meta_table.sql&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üìã Verification/Creation of metadata table&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ Metadata table ready&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_upload_stage" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_upload_stage</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_http_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_download_and_upload_file_http_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for download_and_upload_file in case of HTTP error.
Verifies that the function raises an exception when the HTTP download fails.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_download_and_upload_file_http_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for download_and_upload_file in case of HTTP error.</span>
<span class="sd">    Verifies that the function raises an exception when the HTTP download fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;HTTP Error&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.requests.get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.tempfile.NamedTemporaryFile&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;http://example.com/test.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_snowflake_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_download_and_upload_file_snowflake_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for download_and_upload_file in case of Snowflake error.
Verifies that the function raises an exception when the Snowflake upload fails.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_download_and_upload_file_snowflake_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for download_and_upload_file in case of Snowflake error.</span>
<span class="sd">    Verifies that the function raises an exception when the Snowflake upload fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;fake parquet content&quot;</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/tmp/tempfile_123.parquet&quot;</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="fm">__enter__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_temp_file</span><span class="p">)</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.requests.get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.tempfile.NamedTemporaryFile&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_temp_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">):</span>
                <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Snowflake PUT failed&quot;</span><span class="p">)</span>       
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Snowflake PUT failed&quot;</span><span class="p">):</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;http://example.com/test.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_download_and_upload_file_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for download_and_upload_file in case of success.
Verifies that the function downloads the file from the URL, uploads it to Snowflake
via PUT, and automatically cleans up the temporary file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_download_and_upload_file_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for download_and_upload_file in case of success.</span>
<span class="sd">    Verifies that the function downloads the file from the URL, uploads it to Snowflake</span>
<span class="sd">    via PUT, and automatically cleans up the temporary file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;fake parquet content&quot;</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/tmp/tempfile_123.parquet&quot;</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="fm">__enter__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_temp_file</span><span class="p">)</span>
    <span class="n">mock_temp_file</span><span class="o">.</span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.requests.get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.tempfile.NamedTemporaryFile&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_tempfile</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                <span class="n">mock_tempfile</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_temp_file</span>
                <span class="n">stage</span><span class="o">.</span><span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;http://example.com/test.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)</span>

                <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;fake parquet content&quot;</span><span class="p">)</span>
                <span class="n">mock_temp_file</span><span class="o">.</span><span class="n">flush</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;PUT &#39;file:///tmp/tempfile_123.parquet&#39; @~/test.parquet AUTO_COMPRESS=FALSE&quot;</span><span class="p">)</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üì• Downloading test.parquet...&quot;</span><span class="p">)</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üì§ Uploading to Snowflake...&quot;</span><span class="p">)</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ test.parquet uploaded and temporary file cleaned&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_download_and_upload_file_tempfile_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_download_and_upload_file_tempfile_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for download_and_upload_file in case of temporary file creation error.
Verifies that the function raises an exception when temporary file creation fails.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_download_and_upload_file_tempfile_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for download_and_upload_file in case of temporary file creation error.</span>
<span class="sd">    Verifies that the function raises an exception when temporary file creation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;fake parquet content&quot;</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.requests.get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.tempfile.NamedTemporaryFile&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_tempfile</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">):</span>
                <span class="n">mock_tempfile</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Cannot create temp file&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Cannot create temp file&quot;</span><span class="p">):</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">download_and_upload_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;http://example.com/test.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_main_file_processing_flow" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_file_processing_flow</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the complete file processing flow.
Verifies the order of operations: DB connection, metadata retrieval,
download, upload, status update.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_file_processing_flow</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for the complete file processing flow.</span>
<span class="sd">    Verifies the order of operations: DB connection, metadata retrieval,</span>
<span class="sd">    download, upload, status update.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>

    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;http://example.com/test.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)]</span>
    <span class="n">execute_calls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">execute_calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">track_execute</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.run_sql_file&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.download_and_upload_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">):</span>
                        <span class="n">stage</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                        <span class="n">staged_updates</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">execute_calls</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;UPDATE&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;STAGED&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">staged_updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">staged_updates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">update_args</span> <span class="o">=</span> <span class="n">staged_updates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                        <span class="k">assert</span> <span class="n">update_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;test.parquet&#39;</span><span class="p">,)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_main_with_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_with_files</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the main function with files to upload.
Verifies that the function retrieves the scraped files, downloads them,
uploads them to Snowflake and updates the status in the metadata.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_with_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for the main function with files to upload.</span>
<span class="sd">    Verifies that the function retrieves the scraped files, downloads them,</span>
<span class="sd">    uploads them to Snowflake and updates the status in the metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>

    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;http://example.com/file1.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;http://example.com/file2.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;file2.parquet&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.run_sql_file&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.download_and_upload_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_download</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                        <span class="n">stage</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                        <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üì¶ 2 files to upload&quot;</span><span class="p">)</span>
                        <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ file1.parquet uploaded&quot;</span><span class="p">)</span>
                        <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ file2.parquet uploaded&quot;</span><span class="p">)</span>
                        <span class="n">update_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args_list</span> 
                                      <span class="k">if</span> <span class="s1">&#39;UPDATE&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="s1">&#39;STAGED&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_upload_stage.test_main_with_upload_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_with_upload_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Unit test for the main function with upload error.
Verifies that the function correctly handles upload errors by updating
the status to FAILED_STAGE.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_upload_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_with_upload_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test for the main function with upload error.</span>
<span class="sd">    Verifies that the function correctly handles upload errors by updating</span>
<span class="sd">    the status to FAILED_STAGE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;http://example.com/file1.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">)]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.functions.run_sql_file&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.download_and_upload_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_download</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.upload_stage.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                        <span class="n">mock_download</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Upload failed&quot;</span><span class="p">)</span>
                        <span class="n">stage</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                        <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;‚ùå Upload error file1.parquet: Upload failed&quot;</span><span class="p">)</span>
                        <span class="n">update_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args_list</span> 
                                      <span class="k">if</span> <span class="s1">&#39;FAILED_STAGE&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_load_to_table" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_load_to_table</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_cleanup_stage_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_cleanup_stage_file</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the removal of a processed file from the Snowflake stage.
Verifies the correct REMOVE command is executed and a success log is recorded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_cleanup_stage_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the removal of a processed file from the Snowflake stage.</span>
<span class="sd">    Verifies the correct REMOVE command is executed and a success log is recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
        <span class="n">load</span><span class="o">.</span><span class="n">cleanup_stage_file</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">)</span>
        <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;REMOVE @~/test_file.parquet&quot;</span><span class="p">)</span>
        <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;‚úÖ test_file.parquet removed from stage&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_copy_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_copy_file_to_table_and_count_copy_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the handling of an exception raised during the COPY INTO execution.
Verifies that the exception is propagated and not caught within the function.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_copy_file_to_table_and_count_copy_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the handling of an exception raised during the COPY INTO execution.</span>
<span class="sd">    Verifies that the exception is propagated and not caught within the function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;COPY failed&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
        <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">table_schema</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">)]</span>
            <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;COPY failed&quot;</span><span class="p">):</span>
                <span class="n">load</span><span class="o">.</span><span class="n">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_copy_file_to_table_and_count_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the successful execution of COPY INTO command.
Verifies the command execution, correct parsing of the result,
logging of success with row count, and the return of the correct number of loaded rows.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_copy_file_to_table_and_count_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the successful execution of COPY INTO command.</span>
<span class="sd">    Verifies the command execution, correct parsing of the result,</span>
<span class="sd">    logging of success with row count, and the return of the correct number of loaded rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;test_file.parquet&#39;</span><span class="p">,</span> <span class="s1">&#39;LOADED&#39;</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
        <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">table_schema</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">)]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">250</span>
            <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;‚úÖ test_file.parquet loaded (250 rows)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_copy_file_to_table_and_count_zero_loaded" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_copy_file_to_table_and_count_zero_loaded</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the COPY INTO command when no rows are processed.
Verifies the function returns 0 when the execution result indicates no files were processed.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_copy_file_to_table_and_count_zero_loaded</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the COPY INTO command when no rows are processed.</span>
<span class="sd">    Verifies the function returns 0 when the execution result indicates no files were processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Copy executed with 0 files processed.&#39;</span><span class="p">,)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
        <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">table_schema</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">)]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">copy_file_to_table_and_count</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_create_table_no_schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_create_table_no_schema</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the behavior when the stage contains no data.
Verifies that only the schema detection script runs, a warning is logged,
no table creation SQL is executed, and an empty schema list is returned.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_table_no_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the behavior when the stage contains no data.</span>
<span class="sd">    Verifies that only the schema detection script runs, a warning is logged,</span>
<span class="sd">    no table creation SQL is executed, and an empty schema list is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

            <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;detect_file_schema_stage.sql&quot;</span><span class="p">)</span>
            <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è  No data in STAGE&quot;</span><span class="p">)</span>
            <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
            <span class="n">create_sequence_call</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_sequence.sql&quot;</span><span class="p">)</span>
            <span class="n">add_filename_call</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;add_filename_to_raw_table.sql&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">create_sequence_call</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">call_args_list</span>
            <span class="k">assert</span> <span class="n">add_filename_call</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">call_args_list</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_create_table_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_create_table_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the successful creation of a table with dynamic schema detection.
Verifies that all SQL files are executed in the correct order,
the correct CREATE TABLE statement is generated, appropriate logs are recorded,
and the correct table schema is returned.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_table_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the successful creation of a table with dynamic schema detection.</span>
<span class="sd">    Verifies that all SQL files are executed in the correct order,</span>
<span class="sd">    the correct CREATE TABLE statement is generated, appropriate logs are recorded,</span>
<span class="sd">    and the correct table schema is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;vendor_id&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;tpep_dropoff_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;detect_file_schema_stage.sql&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_sequence.sql&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">load</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;add_filename_to_raw_table.sql&quot;</span><span class="p">)</span>

            <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">create_call</span> <span class="o">=</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="s2">&quot;CREATE TABLE IF NOT EXISTS&quot;</span> <span class="ow">in</span> <span class="n">create_call</span>
            <span class="k">assert</span> <span class="s2">&quot;vendor_id NUMBER&quot;</span> <span class="ow">in</span> <span class="n">create_call</span>
            <span class="k">assert</span> <span class="s2">&quot;tpep_pickup_datetime TIMESTAMP_NTZ&quot;</span> <span class="ow">in</span> <span class="n">create_call</span>

            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìã Dynamic verification/creation of table </span><span class="si">{</span><span class="n">load</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Table </span><span class="si">{</span><span class="n">load</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">RAW_TABLE</span><span class="si">}</span><span class="s2"> ready&quot;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;vendor_id&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;tpep_dropoff_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP_NTZ&quot;</span><span class="p">)</span>
            <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_handle_loading_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_handle_loading_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the error handling flow when a file fails to load.
Verifies that an error is logged, the metadata table is updated to 'FAILED_LOAD',
and a debug log is recorded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_handle_loading_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the error handling flow when a file fails to load.</span>
<span class="sd">    Verifies that an error is logged, the metadata table is updated to &#39;FAILED_LOAD&#39;,</span>
<span class="sd">    and a debug log is recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">test_error</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;COPY INTO failed&quot;</span><span class="p">)</span>
    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
        <span class="n">load</span><span class="o">.</span><span class="n">handle_loading_error</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,</span> <span class="n">test_error</span><span class="p">)</span>
        <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Loading error test_file.parquet: COPY INTO failed&quot;</span><span class="p">)</span>
        <span class="n">mock_logger</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">load</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">update_call</span> <span class="o">=</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args</span>
        <span class="k">assert</span> <span class="s2">&quot;FAILED_LOAD&quot;</span> <span class="ow">in</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_complete_flow_with_counts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_complete_flow_with_counts</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests a complete successful flow with a single file, verifying precise function call sequence.
Ensures update_metadata and cleanup_stage_file are called exactly once with the correct arguments.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_complete_flow_with_counts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests a complete successful flow with a single file, verifying precise function call sequence.</span>
<span class="sd">    Ensures update_metadata and cleanup_stage_file are called exactly once with the correct arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;file1.parquet&quot;</span><span class="p">,)]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.copy_file_to_table_and_count&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.update_metadata&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_update</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.cleanup_stage_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_cleanup</span><span class="p">:</span>
                                <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                                    <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                                    <span class="n">mock_update</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
                                    <span class="n">mock_cleanup</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_connection_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_connection_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the main flow when the initial database connection fails.
Verifies that the connection exception propagates and stops the process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_connection_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the main flow when the initial database connection fails.</span>
<span class="sd">    Verifies that the connection exception propagates and stops the process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="n">mock_connect</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection failed&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Connection failed&quot;</span><span class="p">):</span>
            <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_exception_handling_in_loop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_exception_handling_in_loop</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests error handling within the file processing loop.
Verifies that an error on one file triggers handle_loading_error for that file,
while other files continue processing normally (update and cleanup are called for successful files).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_exception_handling_in_loop</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests error handling within the file processing loop.</span>
<span class="sd">    Verifies that an error on one file triggers handle_loading_error for that file,</span>
<span class="sd">    while other files continue processing normally (update and cleanup are called for successful files).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;file1.parquet&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;file2.parquet&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;file3.parquet&quot;</span><span class="p">,)]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.copy_file_to_table_and_count&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_copy</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.update_metadata&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_update</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.cleanup_stage_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_cleanup</span><span class="p">:</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.handle_loading_error&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_handle_error</span><span class="p">:</span>
                                    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                                        <span class="k">def</span><span class="w"> </span><span class="nf">mock_copy_side_effect</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;file2.parquet&quot;</span><span class="p">:</span>
                                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error on file2&quot;</span><span class="p">)</span>
                                            <span class="k">return</span> <span class="mi">100</span>
                                        <span class="n">mock_copy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">mock_copy_side_effect</span>
                                        <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                                        <span class="k">assert</span> <span class="n">mock_copy</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
                                        <span class="n">mock_handle_error</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file2.parquet&quot;</span><span class="p">,</span> <span class="n">ANY</span><span class="p">)</span>
                                        <span class="k">assert</span> <span class="n">mock_update</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
                                        <span class="k">assert</span> <span class="n">mock_cleanup</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_multiple_files_different_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_multiple_files_different_results</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests processing multiple files with different row counts.
Verifies that update_metadata is called for each file with its respective row count.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_multiple_files_different_results</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests processing multiple files with different row counts.</span>
<span class="sd">    Verifies that update_metadata is called for each file with its respective row count.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;small_file.parquet&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;large_file.parquet&quot;</span><span class="p">,)]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.copy_file_to_table_and_count&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_copy</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.update_metadata&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_update</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.cleanup_stage_file&#39;</span><span class="p">):</span>
                                <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                                    <span class="n">mock_copy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
                                    <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                                    <span class="n">update_calls</span> <span class="o">=</span> <span class="n">mock_update</span><span class="o">.</span><span class="n">call_args_list</span>
                                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                                    <span class="k">assert</span> <span class="n">update_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;small_file.parquet&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                                    <span class="k">assert</span> <span class="n">update_calls</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;large_file.parquet&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_no_staged_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_no_staged_files</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the main flow when no files are found in the stage.
Verifies that the stage analysis log occurs but no copy operations are attempted.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_no_staged_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the main flow when no files are found in the stage.</span>
<span class="sd">    Verifies that the stage analysis log occurs but no copy operations are attempted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                        <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                        <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üîç Analyzing files in STAGE&quot;</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;COPY INTO&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_success_flow" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_success_flow</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the complete successful main execution flow with two files.
Verifies the full sequence: connection, context setting, table creation,
fetching staged files, loading each file, updating metadata, and cleanup.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_success_flow</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the complete successful main execution flow with two files.</span>
<span class="sd">    Verifies the full sequence: connection, context setting, table creation,</span>
<span class="sd">    fetching staged files, loading each file, updating metadata, and cleanup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[(</span><span class="s2">&quot;file1.parquet&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;file2.parquet&quot;</span><span class="p">,)],</span>
    <span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.copy_file_to_table_and_count&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_copy</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.update_metadata&#39;</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.cleanup_stage_file&#39;</span><span class="p">):</span>
                                <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                                    <span class="n">mock_copy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">100</span>
                                    <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üîç Analyzing files in STAGE&quot;</span><span class="p">)</span>
                                    <span class="k">assert</span> <span class="n">mock_copy</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
                                    <span class="n">mock_copy</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)])</span>
                                    <span class="n">mock_copy</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file2.parquet&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_table_creation_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_table_creation_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the main flow when table creation fails.
Verifies that the exception from create_table propagates and stops the main process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_table_creation_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the main flow when table creation fails.</span>
<span class="sd">    Verifies that the exception from create_table propagates and stops the main process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_create_table</span><span class="p">:</span>
                <span class="n">mock_create_table</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Table creation failed&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Table creation failed&quot;</span><span class="p">):</span>
                    <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_main_with_loading_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_with_loading_error</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the main flow when one file fails to load.
Verifies that the error handler is called for the failed file,
while successful files continue processing normally.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_with_loading_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the main flow when one file fails to load.</span>
<span class="sd">    Verifies that the error handler is called for the failed file,</span>
<span class="sd">    while successful files continue processing normally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;file1.parquet&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;file2.parquet&quot;</span><span class="p">,)]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.use_context&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.create_table&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;vendorid&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMBER&quot;</span><span class="p">)]):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.functions.run_sql_file&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.copy_file_to_table_and_count&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_copy</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.update_metadata&#39;</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.cleanup_stage_file&#39;</span><span class="p">):</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.handle_loading_error&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_handle_error</span><span class="p">:</span>
                                    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
                                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
                                        <span class="k">def</span><span class="w"> </span><span class="nf">mock_copy_side_effect</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;file1.parquet&quot;</span><span class="p">:</span>
                                                <span class="k">return</span> <span class="mi">100</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;COPY INTO failed&quot;</span><span class="p">)</span>
                                        <span class="n">mock_copy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">mock_copy_side_effect</span>
                                        <span class="n">load</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                                        <span class="k">assert</span> <span class="n">mock_copy</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
                                        <span class="n">mock_handle_error</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;file2.parquet&quot;</span><span class="p">,</span> <span class="n">ANY</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_load_to_table.test_update_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_update_metadata</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Tests the successful update of the metadata table after a file load.
Verifies the correct UPDATE SQL is executed with the proper parameters
and that a debug log is recorded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_load_to_table.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_update_metadata</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the successful update of the metadata table after a file load.</span>
<span class="sd">    Verifies the correct UPDATE SQL is executed with the proper parameters</span>
<span class="sd">    and that a debug log is recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="c1"># Correction: Patcher le logger dans le module load_to_table directement</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.load_to_table.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
        <span class="n">load</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="s2">&quot;test_file.parquet&quot;</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
        <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">update_call</span> <span class="o">=</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_args</span>
        <span class="k">assert</span> <span class="s2">&quot;UPDATE&quot;</span> <span class="ow">in</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s2">&quot;rows_loaded&quot;</span> <span class="ow">in</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s2">&quot;SUCCESS&quot;</span> <span class="ow">in</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">250</span>
        <span class="k">assert</span> <span class="n">update_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test_file.parquet&quot;</span>
        <span class="n">mock_logger</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Loading </span><span class="si">{</span><span class="n">load</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="snowflake_ingestion.tests.test_backup_policy" class="doc doc-heading">
            <code>snowflake_ingestion.tests.test_backup_policy</code>


</h3>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_backup_policy.test_backup_configuration_values" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_backup_configuration_values</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test backup configuration constants are properly accessed and logged.</p>
<p>Ensures retention days for different backup policies are correctly
formatted in log messages.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_backup_configuration_values</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test backup configuration constants are properly accessed and logged.</span>

<span class="sd">    Ensures retention days for different backup policies are correctly</span>
<span class="sd">    formatted in log messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.run_sql_file&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.DW_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;PRODUCTION_DW&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.RAW_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;YELLOW_TAXI&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FINAL_SCHEMA&#39;</span><span class="p">,</span> <span class="s1">&#39;ANALYTICS&#39;</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FULL_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">365</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.RAW_TABLE_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">730</span><span class="p">):</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FINAL_SCHEMA_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">180</span><span class="p">):</span>

                                    <span class="n">backup</span><span class="o">.</span><span class="n">create_and_set_backup</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ PRODUCTION_DW_BACKUP retention : 365&quot;</span><span class="p">)</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ YELLOW_TAXI_BACKUP retention : 730&quot;</span><span class="p">)</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ ANALYTICS_BACKUP retention : 180&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_backup_policy.test_create_and_set_backup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_create_and_set_backup</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test the create_and_set_backup function execution.</p>
<p>Verifies that the function runs the correct SQL file and logs appropriate
messages with retention period information for each backup policy.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_and_set_backup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the create_and_set_backup function execution.</span>

<span class="sd">    Verifies that the function runs the correct SQL file and logs appropriate</span>
<span class="sd">    messages with retention period information for each backup policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.run_sql_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_sql</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.DW_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;TEST_DW&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.RAW_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;TEST_RAW&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FINAL_SCHEMA&#39;</span><span class="p">,</span> <span class="s1">&#39;TEST_FINAL&#39;</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FULL_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.RAW_TABLE_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">180</span><span class="p">):</span>
                                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.FINAL_SCHEMA_BACKUP_POLICY_DAYS&#39;</span><span class="p">,</span> <span class="mi">365</span><span class="p">):</span>

                                    <span class="n">backup</span><span class="o">.</span><span class="n">create_and_set_backup</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>

                                    <span class="n">expected_sql_file</span> <span class="o">=</span> <span class="n">backup</span><span class="o">.</span><span class="n">SQL_DIR</span> <span class="o">/</span> <span class="s2">&quot;create_and_set_backup.sql&quot;</span>
                                    <span class="n">mock_run_sql</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">,</span> <span class="n">expected_sql_file</span><span class="p">)</span>

                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;üîê Creating backup policies and sets...&quot;</span><span class="p">)</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ TEST_DW_BACKUP retention : 90&quot;</span><span class="p">)</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ TEST_RAW_BACKUP retention : 180&quot;</span><span class="p">)</span>
                                    <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;‚úÖ TEST_FINAL_BACKUP retention : 365&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_backup_policy.test_main_exception" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_exception</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test error handling in main function when an exception occurs.</p>
<p>Verifies that exceptions are caught and logged as errors without crashing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test error handling in main function when an exception occurs.</span>

<span class="sd">    Verifies that exceptions are caught and logged as errors without crashing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_exception</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection failed: Invalid credentials&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">test_exception</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>

            <span class="n">backup</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
            <span class="n">mock_logger</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">test_exception</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_backup_policy.test_main_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_success</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test the main function with successful backup setup workflow.</p>
<p>Ensures connection is made with SYSADMIN role, backup function is called,
connection is closed properly, and success is logged.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_success</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the main function with successful backup setup workflow.</span>

<span class="sd">    Ensures connection is made with SYSADMIN role, backup function is called,</span>
<span class="sd">    connection is closed properly, and success is logged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_cursor</span><span class="p">)</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.create_and_set_backup&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_create_backup</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.logger&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_logger</span><span class="p">:</span>

                <span class="n">backup</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

                <span class="n">mock_connect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                    <span class="n">backup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
                    <span class="n">backup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">,</span>
                    <span class="n">backup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">ACCOUNT</span><span class="p">,</span>
                    <span class="s2">&quot;SYSADMIN&quot;</span>
                <span class="p">)</span>

                <span class="n">mock_create_backup</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_cursor</span><span class="p">)</span>
                <span class="n">mock_conn</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">mock_logger</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;üéØ Complete initialization finished successfully!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="snowflake_ingestion.tests.test_backup_policy.test_main_with_connection_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_main_with_connection_context</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test proper cursor context management in main function.</p>
<p>Verifies that cursor context manager protocols are followed correctly.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>snowflake_ingestion/tests/test_backup_policy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_main_with_connection_context</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test proper cursor context management in main function.</span>

<span class="sd">    Verifies that cursor context manager protocols are followed correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor_context</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">mock_cursor_context</span><span class="o">.</span><span class="fm">__enter__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_cursor</span><span class="p">)</span>
    <span class="n">mock_cursor_context</span><span class="o">.</span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor_context</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.functions.connect_with_role&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_conn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.create_and_set_backup&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;snowflake_ingestion.backup_policy.logger&#39;</span><span class="p">):</span>

                <span class="n">backup</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
                <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">mock_cursor_context</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">mock_cursor_context</span><span class="o">.</span><span class="fm">__exit__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="√öltima actualizaci√≥n">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 17, 2026 15:50:35 UTC">January 17, 2026</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Creado">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 17, 2026 15:50:35 UTC">January 17, 2026</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 - <a href="#__consent" data-md-color-scheme="slate">Change cookie settings</a>

    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/elias-mezine-598a89210/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/EliasMez/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4>Cookie consent</h4>
<p>This site uses Google Analytics to understand how visitors use the documentation. It collects anonymous data about page visits and interactions to help us improve the content. You can accept or decline this analytics tracking below.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
    
    
      
        
  
  
    
    
      
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
      
        
  
  
    
    
      
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
    
    
      <button type="reset" class="md-button md-button--primary">Rechazar</button>
    
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>